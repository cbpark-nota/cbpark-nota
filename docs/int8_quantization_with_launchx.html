<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>INT8 quantization &mdash; LaunchX  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
    <link rel="shortcut icon" href="_static/favicon.png"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Common Issues" href="error_messages.html" />
    <link rel="prev" title="Benchmark" href="compatibility_range_of_benchmark.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            LaunchX
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="compatibility_range_of_conversion.html">Convert</a></li>
<li class="toctree-l1"><a class="reference internal" href="supported_jetpack_onnx_version.html">Supported JetPack-ONNX version</a></li>
<li class="toctree-l1"><a class="reference internal" href="compatibility_range_of_benchmark.html">Benchmark</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">INT8 quantization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-is-quantization">What is Quantization?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">INT8 quantization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparing-the-calibration-dataset">Preparing the calibration dataset</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#convert-the-dataset-to-numpy-for-calibration">Convert the dataset to NumPy for calibration.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#result">Result</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dataset-that-failed-to-be-read">Dataset that failed to be read</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#inference-code-for-tflite-int8">Inference Code for TFlite INT8</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="error_messages.html">Common Issues</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Connection</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://netspresso.ai/">NetsPresso(Linked in, Trainer, Python)</a></li>
<li class="toctree-l1"><a class="reference internal" href="partnerships.html">Partnerships</a></li>
<li class="toctree-l1"><a class="reference internal" href="contact_us.html">Contact us</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LaunchX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">INT8 quantization</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/cbpark-nota/cbpark-nota/blob/sphinx/docs/int8_quantization_with_launchx.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="int8-quantization">
<span id="int8-quantization-with-launchx"></span><h1>INT8 quantization<a class="headerlink" href="#int8-quantization" title="Link to this heading"></a></h1>
<p>You can use LaunchX converter to automatically convert the AI model’s framework to the target framework.</p>
<section id="what-is-quantization">
<h2>What is Quantization?<a class="headerlink" href="#what-is-quantization" title="Link to this heading"></a></h2>
<p>Quantization is a technique that reduces the number of bits used to represent weights and activations in a deep learning model. This makes the model lighter, reducing memory usage and improving inference speed.</p>
<p>LaunchX facilitates the easy application of post-training INT8 quantization to the model. It represents the model’s weights and activations as 8-bit integers, saving memory and accelerating computations.</p>
<p>This document provides information as follows:</p>
<ul class="simple">
<li><p>INT8 quantization</p></li>
<li><p>Preparing the calibration dataset</p></li>
<li><p>Inference code for TFlite INT8 model</p></li>
</ul>
</section>
<section id="id1">
<h2>INT8 quantization<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p>To quantize, upload your target model or select from the free models in Models.</p></li>
<li><p>On the Convert Setting page, choose Tensorflow Lite, select the target device, and then choose the INT8 option.</p></li>
<li><p>Upload the calibration dataset(&lt;= 500MB) to minimize quantization error.</p></li>
<li><p>Click the convert button.</p></li>
</ol>
<img alt="_images/INT8_setting.png" src="_images/INT8_setting.png" />
</section>
<section id="preparing-the-calibration-dataset">
<span id="id2"></span><h2>Preparing the calibration dataset<a class="headerlink" href="#preparing-the-calibration-dataset" title="Link to this heading"></a></h2>
<p>Calibration is the process of aligning a quantized model with a specific data distribution, adjusting quantization parameters such as scaling and zero points.</p>
<p>Generally, the calibration dataset is a subset of the original training data, used to fine-tune quantization parameters. Its purpose is to ensure the quantized model’s optimal performance on real-world data while maintaining acceptable accuracy. During calibration, the model runs on this dataset, and activation statistics are collected. These statistics determine quantization parameters for each neural network layer, minimizing the impact of quantization on accuracy by adapting parameters based on observed value distributions.</p>
<section id="convert-the-dataset-to-numpy-for-calibration">
<h3>Convert the dataset to NumPy for calibration.<a class="headerlink" href="#convert-the-dataset-to-numpy-for-calibration" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>img_file_dir_path : Path where the dataset for calibration is stored.</p></li>
<li><p>padding : Value for padding preprocessing.</p></li>
<li><p>color_mode : Value to change the color mode of an image for preprocessing. Select ‘bgr’ or ‘rgb’.</p></li>
<li><p>normalize : Value for normalization preprocessing.</p></li>
<li><p>input_shape : Value for width and height of model input shape.</p></li>
<li><p>save_file_path : Path to save the npy file.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">img_file_types</span> <span class="o">=</span> <span class="p">[</span>
   <span class="s2">&quot;*.jpeg&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.JPEG&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.jpg&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.JPG&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.png&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.PNG&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.BMP&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.bmp&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.TIF&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.tif&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.TIFF&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.tiff&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.DNG&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.dng&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.WEBP&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.webp&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.mpo&quot;</span><span class="p">,</span>
   <span class="s2">&quot;*.MPO&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">save_npy_file</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">save_file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
   <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_file_name</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_saved_npy_file_shape</span><span class="p">(</span><span class="n">save_file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
   <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">save_file_name</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved npy array shape is </span><span class="si">{</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">save_txt_file</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
   <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">print_error_files</span><span class="p">(</span><span class="n">error_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
   <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please check files in </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error files:&quot;</span><span class="p">,</span> <span class="n">error_files</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">save_error_files</span><span class="p">(</span>
      <span class="n">error_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
      <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;error_files.txt&quot;</span><span class="p">):</span>
   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">save_txt_file</span><span class="p">(</span><span class="n">error_files</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
   <span class="n">print_error_files</span><span class="p">(</span><span class="n">error_files</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DataPreprocessor</span><span class="p">():</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
      <span class="n">input_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
      <span class="n">color_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;bgr&quot;</span><span class="p">,</span> <span class="s2">&quot;rgb&quot;</span><span class="p">],</span>
      <span class="n">padding</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
      <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span>
   <span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span> <span class="o">=</span> <span class="n">root_dir</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">input_shape</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">color_mode</span> <span class="o">=</span> <span class="n">color_mode</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="n">padding</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">img_list</span> <span class="o">=</span> <span class="p">[]</span>

   <span class="k">def</span> <span class="nf">_get_img_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">img_list</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">img_type</span> <span class="ow">in</span> <span class="n">img_file_types</span><span class="p">:</span>
               <span class="n">img_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">img_type</span><span class="p">))</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">img_list</span> <span class="o">+=</span> <span class="n">img_files</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">img_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_list</span><span class="p">))</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No image in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

      <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_list</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">_img_padding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">):</span>
      <span class="n">shape</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># current shape [height, width]</span>
      <span class="n">new_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">new_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_shape</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">)</span>

      <span class="c1"># Scale ratio (new / old)</span>
      <span class="n">r</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

      <span class="c1"># Compute padding</span>
      <span class="n">new_unpad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_unpad</span><span class="p">:</span>  <span class="c1"># resize</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">new_unpad</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>
      <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_unpad</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_unpad</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">))</span>
      <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_unpad</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">new_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_unpad</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">))</span>
      <span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">(</span><span class="mi">114</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">114</span><span class="p">))</span>  <span class="c1"># add border</span>
      <span class="k">return</span> <span class="n">im</span>

   <span class="k">def</span> <span class="nf">_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
      <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">color_mode</span> <span class="o">==</span> <span class="s2">&quot;rgb&quot;</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_img_padding</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>
      <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mf">255.0</span>
      <span class="k">return</span> <span class="n">x</span>

   <span class="k">def</span> <span class="nf">_load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
      <span class="n">error_files</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">valid_images</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="k">def</span> <span class="nf">is_valid_image</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

      <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
               <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
               <span class="k">if</span> <span class="n">is_valid_image</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
                  <span class="n">valid_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
               <span class="k">else</span><span class="p">:</span>
                  <span class="n">error_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
               <span class="n">error_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span>
            <span class="n">result_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">valid_images</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">result_array</span><span class="p">,</span> <span class="n">error_files</span>

   <span class="k">def</span> <span class="nf">_get_save_file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_get_img_list</span><span class="p">()</span>
      <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_list</span><span class="p">)</span>
      <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">.npy&quot;</span>

   <span class="k">def</span> <span class="nf">save_dataset_as_npy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
      <span class="n">save_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_save_file_name</span><span class="p">()</span>
      <span class="n">save_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_file_path</span><span class="p">,</span> <span class="n">save_file_name</span><span class="p">)</span>
      <span class="n">result_array</span><span class="p">,</span> <span class="n">error_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_dataset</span><span class="p">()</span>
      <span class="n">save_npy_file</span><span class="p">(</span><span class="n">result_array</span><span class="p">,</span> <span class="n">save_file_path</span><span class="p">)</span>
      <span class="n">print_saved_npy_file_shape</span><span class="p">(</span><span class="n">save_file_path</span><span class="p">)</span>
      <span class="n">save_error_files</span><span class="p">(</span><span class="n">error_files</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="n">img_file_dir_path</span> <span class="o">=</span> <span class="s2">&quot;/image/file/path&quot;</span>
   <span class="n">padding</span> <span class="o">=</span> <span class="kc">True</span>
   <span class="n">color_mode</span> <span class="o">=</span> <span class="s2">&quot;bgr&quot;</span>
   <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
   <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span>
   <span class="n">save_file_path</span> <span class="o">=</span> <span class="s2">&quot;/path/to/save/file&quot;</span>
   <span class="n">data_preprocessor</span> <span class="o">=</span> <span class="n">DataPreprocessor</span><span class="p">(</span>
      <span class="n">img_file_dir_path</span><span class="p">,</span>
      <span class="n">input_shape</span><span class="p">,</span>
      <span class="n">color_mode</span><span class="p">,</span>
      <span class="n">padding</span><span class="p">,</span>
      <span class="n">normalize</span>
   <span class="p">)</span>
   <span class="n">data_preprocessor</span><span class="o">.</span><span class="n">save_dataset_as_npy</span><span class="p">(</span><span class="n">save_file_path</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="result">
<h3>Result<a class="headerlink" href="#result" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="o">@</span><span class="mf">4e54</span><span class="n">bd5645d1</span><span class="p">:</span><span class="o">/</span><span class="n">app</span><span class="c1"># python3 prepare_npy_file.py</span>
<span class="n">Corrupt</span> <span class="n">JPEG</span> <span class="n">data</span><span class="p">:</span> <span class="mi">122</span> <span class="n">extraneous</span> <span class="nb">bytes</span> <span class="n">before</span> <span class="n">marker</span> <span class="mh">0xc4</span>
<span class="n">Saved</span> <span class="n">npy</span> <span class="n">array</span> <span class="n">shape</span> <span class="ow">is</span> <span class="p">(</span><span class="mi">145</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">Please</span> <span class="n">check</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">error_files</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span>
<span class="n">Error</span> <span class="n">files</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/app/calib_dataset/images/2007_000039_jpg&#39;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="dataset-that-failed-to-be-read">
<h3>Dataset that failed to be read<a class="headerlink" href="#dataset-that-failed-to-be-read" title="Link to this heading"></a></h3>
<p>Image files that do not open normally through opencv-python are listed in the ‘error_files.txt’ created in the code execution location.</p>
<section id="inference-code-for-tflite-int8">
<h4>Inference Code for TFlite INT8<a class="headerlink" href="#inference-code-for-tflite-int8" title="Link to this heading"></a></h4>
<p>Write and use additional pre-processing/post-processing codes for your model.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="k">def</span> <span class="nf">model_input_output_attributes</span><span class="p">(</span><span class="n">interpreter</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">):</span>
   <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="k">for</span> <span class="n">input_detail</span> <span class="ow">in</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">get_input_details</span><span class="p">():</span>
      <span class="n">input_data_attribute</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">input_data_attribute</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
      <span class="n">input_data_attribute</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
      <span class="n">input_data_attribute</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">input_detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">))</span>
      <span class="n">input_data_attribute</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">)</span>
      <span class="n">input_data_attribute</span><span class="p">[</span><span class="s2">&quot;quantization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quantization&quot;</span><span class="p">)</span>
      <span class="n">input_data_attribute</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;nchw&quot;</span> <span class="k">if</span> <span class="n">input_data_attribute</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="s2">&quot;nhwc&quot;</span>
      <span class="n">inputs</span><span class="p">[</span><span class="n">input_data_attribute</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">input_data_attribute</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">input_data_attribute</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">input_data_attribute</span>

   <span class="k">for</span> <span class="n">output_detail</span> <span class="ow">in</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">get_output_details</span><span class="p">():</span>
      <span class="n">output_data_attribute</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">output_data_attribute</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
      <span class="n">output_data_attribute</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
      <span class="n">output_data_attribute</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">output_detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">))</span>
      <span class="n">output_data_attribute</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">)</span>
      <span class="n">output_data_attribute</span><span class="p">[</span><span class="s2">&quot;quantization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_detail</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quantization&quot;</span><span class="p">)</span>
      <span class="n">output_data_attribute</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;nchw&quot;</span> <span class="k">if</span> <span class="n">output_data_attribute</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="s2">&quot;nhwc&quot;</span>
      <span class="n">outputs</span><span class="p">[</span><span class="n">output_data_attribute</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">output_data_attribute</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">output_data_attribute</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">output_data_attribute</span>

   <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span>

<span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">input_image_path</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
   <span class="n">input_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">input_image_path</span><span class="p">)</span>
   <span class="c1"># Write down the pre-processing process required for your model, including resizing.</span>
   <span class="k">return</span> <span class="n">input_image</span>

<span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="n">tflite_model_path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">input_image</span><span class="p">):</span>
   <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tflite_model_path</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">interpreter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">model_content</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
   <span class="n">interpreter</span><span class="o">.</span><span class="n">allocate_tensors</span><span class="p">()</span>

   <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">model_input_output_attributes</span><span class="p">(</span><span class="n">interpreter</span><span class="p">)</span>
   <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">]:</span>
            <span class="n">input_scale</span><span class="p">,</span> <span class="n">input_zero_point</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;quantization&quot;</span><span class="p">]</span>
            <span class="n">input_image</span> <span class="o">=</span> <span class="n">input_image</span> <span class="o">/</span> <span class="n">input_scale</span> <span class="o">+</span> <span class="n">input_zero_point</span>
            <span class="n">input_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">])</span>
      <span class="n">interpreter</span><span class="o">.</span><span class="n">set_tensor</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">],</span> <span class="n">input_image</span><span class="p">)</span>
   <span class="n">interpreter</span><span class="o">.</span><span class="n">invoke</span><span class="p">()</span>

   <span class="n">output_dict</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="k">for</span> <span class="n">output_location</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
      <span class="n">output_dict</span><span class="p">[</span><span class="n">output_location</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="n">output_location</span><span class="p">)</span>

   <span class="k">return</span> <span class="n">output_dict</span>

<span class="k">def</span> <span class="nf">postprocess</span><span class="p">(</span><span class="n">inference_results</span><span class="p">):</span>
   <span class="k">return</span> <span class="n">inference_results</span>

<span class="n">input_image</span><span class="o">=</span><span class="n">preprocess</span><span class="p">(</span><span class="s2">&quot;your_image_file.jpg&quot;</span><span class="p">)</span>
<span class="n">inference_result</span><span class="o">=</span><span class="n">inference</span><span class="p">(</span><span class="s2">&quot;your_model.tflite&quot;</span><span class="p">,</span> <span class="n">input_image</span><span class="p">)</span>
<span class="n">postprocess</span><span class="p">(</span><span class="n">inference_result</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="compatibility_range_of_benchmark.html" class="btn btn-neutral float-left" title="Benchmark" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="error_messages.html" class="btn btn-neutral float-right" title="Common Issues" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Nota.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>